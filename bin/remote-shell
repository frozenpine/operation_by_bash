#!/bin/bash

[[ -L $0 ]] && SCRIPT_FILE=`readlink -fn $0` || SCRIPT_FILE=$0
pushd `dirname "${SCRIPT_FILE}"` >/dev/null
BASE_DIR=`pwd`
popd >/dev/null

source "${BASE_DIR}/module.d/common.sh" || exit 1

HELP_ARGS["H:host"]="Remote host/IP for shell connection."
HELP_ARGS["u:user"]="Login user for remote shell."
HELP_ARGS["p:port"]="Remote port for shell connection."
HELP_ARGS["s:shell"]="Shell name for shell connection."

while getopts :H:u:p:s:h FLAG; do
    case $FLAG in
        H)
            REMOTE_HOST=${OPTARG}
        ;;
        u)
            REMOTE_USER=${OPTARG}
        ;;
        p)
            REMOTE_PORT=${OPTARG}
        ;;
        s)
            SHELL_ARG="-s ${OPTARG}"
        ;;
        h)
            _help >&2
            exit
        ;;
        *)
            error "Invalid args: $*"
        ;;
    esac
done
shift $((OPTIND-1))

if [[ -z ${REMOTE_HOST} ]]; then
    error remote host must be specified by -H
    exit 1
fi

ssh -t ${REMOTE_USER:=`whoami`}@${REMOTE_HOST} -p${REMOTE_PORT:=22} bin/container shell "${SHELL_ARG}" $1
info "Connection to ${REMOTE_HOST}'s container[$1] closed."
