#! /bin/bash

[[ -L $0 ]] && SCRIPT_FILE=`readlink -fn $0` || SCRIPT_FILE=$0
pushd `dirname "${SCRIPT_FILE}"` >/dev/null
BASE_DIR=`pwd`
popd >/dev/null

source "${MODULE_BASE}/common.sh" || exit 1
FUNC_FILE_CONFIG="${BASE_DIR}/config.sh"
import_functions

DRY_RUN=

SERVICE_LIST="zookeeper"

for SERVICE in ${SERVICE_LIST}; do
    source "${BASE_DIR}/service.d/${SERVICE}.sh" || {
        echo "service list file missing: ${SERVICE}.sh" >&2
        exit 1
    }
done

while getopts :d FLAG; do
    case $FLAG in
        d)
            DRY_RUN="echo"
        ;;
        *)
            error "invalid args: $*"
        ;;
    esac
done
shift $((OPTIND-1))

if [[ $# -lt 1 ]]; then
    error "`basename ${SCRIPT_FILE}` command missing: $*"
    exit 1
fi

COMMAND=$1
shift

case ${COMMAND} in
    start)
        allssh -gzookeeper container start zookeeper
    ;;
    stop)
        allssh -gzookeeper container stop zookeeper
    ;;
    kill)
        allssh -gzookeeper container stop -f zookeeper
    ;;
    check)
        allssh -gzookeeper ll /opt
        allssh -gzookeeper container status zookeeper
    ;;
    status)
        allssh -gzookeeper container status zookeeper
        allssh -gzookeeper container exec zookeeper bin/zkServer.sh status
    ;;
    destory)
        allssh -gzookeeper container stop -crf zookeeper
    ;;
    pub)
        allscp -gzookeeper "${BASE_DIR}/container.d/zookeeper.sh"
    ;;
    exec)
        allssh -gzookeeper container exec zookeeper $*
    ;;
    logs)
        allssh -gzookeeper container logs --tail 100 zookeeper
    ;;
    shell)
        IDX=$((RANDOM % ${#ZK_LIST[@]}))
        container-shell -H${ZK_LIST[zk00$((IDX+1))]} zookeeper
    ;;
    *)
        error "invalid command: ${COMMAND}"
        exit 1
    ;;
esac
